#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler/setup'
require 'logger'
require 'optparse'
require_relative '../lib/brb/button'

options = {
  message: 'Ali ALERT!',
  voice: nil,
  verbose: false
}

OptionParser.new do |opts|
  opts.banner = 'Usage: brb-ali [options]'

  opts.on('-m', '--message TEXT', 'Alert message to speak when the button is pushed') do |text|
    options[:message] = text
  end

  opts.on('--voice NAME', 'Voice to use with the system say command') do |name|
    options[:voice] = name
  end

  opts.on('-v', '--verbose', 'Enable verbose logging') do
    options[:verbose] = true
  end

  opts.on('-h', '--help', 'Show this help message') do
    puts opts
    exit
  end
end.parse!

logger = options[:verbose] ? Logger.new($stderr) : nil

button = Brb::Button.new(logger: logger)

button.on_push do
  puts 'alarm'
  system('osascript', '-e', 'set Volume 5')
  say_command = ['say']
  say_command += ['-v', options[:voice]] if options[:voice]
  say_command << options[:message]
  system(*say_command)
  system('osascript', '-e', 'set Volume 0')
end

button.run
